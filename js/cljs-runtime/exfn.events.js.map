{"version":3,"sources":["exfn/events.cljs"],"mappings":"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","names":["re_frame.core.reg_event_db","_","exfn.events/dispatch-timer-event","re-frame.core/dispatch","p__34541","vec__34542","cljs.core.nth","db","source","cljs.core.assoc","re-frame.core/reg-fx","js/document","re_frame.core.reg_event_fx","p__34545","map__34546","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","parsed","exfn.parser/parse","symbol-table","exfn.interpreter/build-symbol-table","cljs.core/count","scroll-pos","p__34548","p__34549","map__34550","vec__34551","p__34555","p__34556","map__34557","vec__34558","breakpoints","line-no","clojure.set.difference","cljs.core.conj","p__34562","vec__34563","handle","p__34566","vec__34567","running?","speed","js/setInterval","js/clearInterval","eip","p__34570","map__34571","cljs.core/not","p__34573","vec__34574","finished?","p__34577","map__34578","exfn.events/append-output","existing","new","and__4115__auto__","cljs.core._EQ_","p__34580","map__34581","vec__34583","memory","output","exfn.interpreter/interpret","G__34586","p__34587","vec__34588","vec__34591","k","v","cljs.core.update_in","cljs.core/assoc","p__34594","vec__34595","p__34598","vec__34599","cljs.core/conj","cljs.core/assoc-in"],"sourcesContent":["(ns exfn.events\n  (:require [exfn.parser :refer [parse]]\n            [re-frame.core :as rf]\n            [exfn.interpreter :as interp]\n            [clojure.set :as set]))\n\n(rf/reg-event-db\n :initialize\n (fn [_ _]\n   {:source      \"; function calls.\nmov a 0    ; a = 0\nmov b 1    ; a = 0, b = 1\nmov c 2    ; a = 0, b = 1, c = 2\nprn b\ncall foo   ; move eip to foo, push eip to eip-stack\nmul c b    ; a = 0, b = 2, c = 4\ncmp a b    ; :cmp = lt\njne quax   ; jump\nmul c 10   ;\n\n\n;; quax:: call bar and zero :b\nquax:      ;\nnop        ;\ncall bar   ; move eip to bar, push eip to eip-stack\npop d\npop e\nprn d\nprn e\nxor b b    ; a = 7, b = 0, c = 3\nend        ; a = 7, b = 0, c = 3\n\n\n;; foo:: increment b\nfoo:\ninc b      ; a = 0, b = 2, c = 2\nret        ; ret to foo call, pop eip stack\n\n\n;; bar:: add 7 to a and decrement c\nbar:\nadd a 7    ; a = 7, b = 2, c = 4\nsub c 1    ; a = 7, b = 2, c = 3\npush 3\npush 4\nret        ; ret to bar call, pop eip stack\"\n    :breakpoints #{}\n    :code        []\n    :finished? false\n    :has-parsed-code? false\n    :memory {:eip                0\n             :registers          {}\n             :eip-stack          []\n             :internal-registers {}\n             :stack              []\n             :symbol-table       {}\n             :last-edit-register nil}\n    :on-breakpoint false\n    :output \"Output >>\\n---------------------------------\"\n    :running? false\n    :running-speed 700\n    :ticker-handle nil}))\n\n(defn dispatch-timer-event []\n  (rf/dispatch [:next-instruction]))\n\n;; Handles the user typing into the source control editor.\n(rf/reg-event-db\n :update-source\n (fn [db [_ source]]\n   (assoc db :source source)))\n\n(rf/reg-fx\n :scroll-parsed-code-to-top\n (fn [_]\n   (-> js/document\n       (.getElementById \"code-container\")\n       (.-scrollTop)\n       (set! 0))))\n\n;; Handles when the user clicks the Parse button.\n(rf/reg-event-fx\n :parse\n (fn [{:keys [db]} _]\n   (let [parsed (parse (db :source))\n         symbol-table (interp/build-symbol-table parsed)]\n     {:db\n      (-> db\n          (assoc :memory {:eip                0\n                          :registers          {}\n                          :eip-stack          []\n                          :internal-registers {}\n                          :stack              []\n                          :symbol-table       symbol-table})\n          (assoc :code parsed)\n          (assoc :on-breakpoint false)\n          (assoc :has-parsed-code? (pos? (count parsed)))\n          (assoc :finished? false))\n      :scroll-parsed-code-to-top _})))\n\n; Handles when the user clicks the Clear Parsed button\n(rf/reg-event-db\n :clear-parsed\n (fn [db _]\n   (-> db\n       (assoc :code [])\n       (assoc :running? false)\n       (assoc :has-parsed-code? false)\n       (assoc :on-breakpoint false)\n       (assoc :memory {:eip                0\n                       :registers          {}\n                       :eip-stack          []\n                       :internal-registers {}\n                       :stack              []\n                       :symbol-table       []}))))\n\n; Handles when the user clicks Clear Breakpoints button\n(rf/reg-event-db\n :clear-breakpoints\n (fn [db _]\n   (assoc db :breakpoints #{})))\n\n;; ====================================================================\n;; Source Code Editor events\n;; ====================================================================\n\n; replace with\n;(reagent/with-let [ref2 (reagent/atom nil)]\n;   [:div\n;    [:textarea {:on-scroll (fn [^js e] (when-some [node2 @ref2] ...))}]\n;    [:textarea {:ref #(reset! ref2 %)}]])\n\n(rf/reg-fx\n :scroll-line-nos\n (fn [scroll-pos]\n   (-> js/document\n       (.getElementById \"lineNos\")\n       (.-scrollTop)\n       (set! scroll-pos))))\n\n(rf/reg-event-fx\n :update-scroll\n (fn [{:keys [db]} [_ scroll-pos]]\n   {:db (assoc db :scroll-pos scroll-pos)\n    :scroll-line-nos scroll-pos}))\n\n;; ===================================================================\n;; Parsed code events\n;; ===================================================================\n(rf/reg-event-db\n :toggle-breakpoint\n (fn [{:keys [breakpoints] :as db} [_ line-no]]\n   (assoc db :breakpoints (if (some? (breakpoints line-no))\n                            (set/difference  breakpoints #{line-no})\n                            (conj breakpoints line-no)))))\n\n;; ===================================================================\n;; Code execution control events\n;; ===================================================================\n(rf/reg-event-db\n :set-handle\n (fn [db [_ handle]]\n   (assoc db :ticker-handle handle)))\n\n(rf/reg-fx\n :toggle-running\n (fn [[running? handle speed]]\n   (if running?\n     (rf/dispatch [:set-handle (js/setInterval dispatch-timer-event speed)])\n     (js/clearInterval handle))))\n\n(rf/reg-fx\n :scroll-current-code-into-view\n (fn [eip]\n   (-> js/document\n       (.getElementById \"code-container\")\n       (.-scrollTop)\n       (set! (* eip 25)))))\n\n(rf/reg-event-fx\n :toggle-running\n (fn [{:keys [db]} _]\n   {:db (assoc db :running? (not (db :running?)))\n    :toggle-running [(not (db :running?)) (db :ticker-handle) (db :running-speed)]}))\n\n(rf/reg-fx\n :end-if-finished\n (fn [[handle finished?]]\n   (when finished?\n     (js/clearInterval handle))))\n\n(rf/reg-event-fx\n :reset\n (fn [{:keys [db]} _]\n   {:db (-> db\n            (assoc :memory {:eip                0\n                            :registers          {}\n                            :eip-stack          []\n                            :internal-registers {}\n                            :stack              []\n                            :symbol-table (:symbol-table (:memory db))})\n            (assoc :running? false)\n            (assoc :on-breakpoint false)\n            (assoc :finished? false))\n    :toggle-running [false (db :ticker-handle)]\n    :scroll-parsed-code-to-top _}))\n\n(defn append-output [existing new]\n  (cond (and existing new) ;existing output and new output.\n        (str existing \"\\n\" new)\n\n        (and existing (not new))\n        existing\n\n        (= \"\" existing)\n        new))\n\n\n(rf/reg-event-fx\n :next-instruction\n (fn [{:keys [db]} _]\n   (let [[memory finished? output] (exfn.interpreter/interpret (db :code) (db :memory))\n         breakpoints (db :breakpoints)\n         db (-> db\n                (assoc :memory memory)\n                (assoc :finished? finished?)\n                (assoc :output (append-output (db :output) output)))]\n     (if (some? (breakpoints (:eip memory)))\n       {:db (-> db\n                (assoc :on-breakpoint true)\n                (assoc :running? false))\n        :scroll-current-code-into-view (:eip memory)\n        :toggle-running [false (db :ticker-handle)]}\n       {:db (assoc db :on-breakpoint false)\n        :scroll-current-code-into-view (:eip memory)\n        :end-if-finished [(db :ticker-handle) finished?]}))))\n\n(rf/reg-event-db\n :clear-output\n (fn [db _]\n   (assoc db :output \"Output >>\\n---------------------------------\")))\n\n ;;================== DEV TEST EVENTS ==================================\n(rf/reg-event-db\n :add-value-to-registers\n (fn [db [_ [k v]]]\n   (update-in db [:memory :registers] assoc k v)))\n\n(rf/reg-event-db\n :update-running-speed\n (fn [db [_ speed]]\n   (assoc db :running-speed speed)))\n\n(rf/reg-event-db\n :add-value-to-stack\n (fn [db [_ v]]\n   (update-in db [:memory :stack] conj v)))\n\n(rf/reg-event-db\n :reset-eip\n (fn [db _]\n   (assoc-in db [:memory :eip] 0)))\n\n(rf/reg-event-db\n :test-code\n (fn [db _]\n   (assoc db :source \"; function calls.\nmov a 0    ; a = 0\nmov b 1    ; a = 0, b = 1\nmov c 2    ; a = 0, b = 1, c = 2\ncall foo   ; move eip to foo, push eip to eip-stack\nmul c b    ; a = 0, b = 2, c = 4\ncmp a b    ; :cmp = lt\njne quax   ; jump\nmul c 10   ;\n                      \n\n;; quax:: call bar and zero :b\nquax:      ;\nnop        ;\ncall bar   ; move eip to bar, push eip to eip-stack\nxor b b    ; a = 7, b = 0, c = 3\nend        ; a = 7, b = 0, c = 3\n                      \n\n;; foo:: increment b\nfoo:\ninc b      ; a = 0, b = 2, c = 2\nret        ; ret to foo call, pop eip stack\n\n\n;; bar:: add 7 to a and decrement c\nbar:\nadd a 7    ; a = 7, b = 2, c = 4\nsub c 1    ; a = 7, b = 2, c = 3\nret        ; ret to bar call, pop eip stack\")))"]}