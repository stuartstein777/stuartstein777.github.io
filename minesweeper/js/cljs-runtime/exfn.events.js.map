{"version":3,"sources":["exfn/events.cljs"],"mappings":"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","names":["exfn.events/dispatch-timer-event","re-frame.core/dispatch","re_frame.core.reg_event_db","_","exfn.logic/generate-full-board","p__37839","vec__37840","cljs.core.nth","db","handle","cljs.core.assoc","p__37843","map__37844","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","ticking?","cljs.core.update","cljs.core/inc","re-frame.core/reg-fx","p__37846","vec__37847","js/setInterval","p__37850","vec__37851","js/clearInterval","re_frame.core.reg_event_fx","p__37854","map__37855","p__37857","map__37858","cljs.core.prn","cljs.core/not","p__37860","vec__37861","finished?","p__37864","p__37865","map__37866","vec__37867","exfn.events/reveal-numbers-with-flags","board","mines","x","y","revealed","exfn.logic/reveal-with-flags","cljs.core._EQ_","up-revealed","clojure.set.union","also-revealed","exfn.logic/reveal","fin-revealed","game-won?","exfn.logic/game-won?","updated-db","clojure.set/difference","p__37871","p__37872","map__37873","vec__37874","exfn.events/reveal-blank","new-revealed","clojure.set.difference","p__37878","p__37879","map__37880","vec__37881","exfn.events/reveal-numbers","p__37885","p__37886","map__37887","vec__37888","vec__37891","contents","cljs.core.get_in","up-db","G__37898","fexpr__37897","or__4126__auto__","p__37899","p__37900","map__37901","vec__37902","flags","cell","up-flags","cljs.core.conj","p__37906","vec__37907","game"],"sourcesContent":["(ns exfn.events\n  (:require [re-frame.core :as rf]\n            [exfn.logic :as bf]\n            [clojure.set :as set]))\n\n(defn dispatch-timer-event []\n  (rf/dispatch [:tick]))\n\n(rf/reg-event-db\n :initialize\n (fn [_ _]\n   {:board (bf/generate-full-board {:dimensions [16 16] :mines 40})\n    :revealed #{}\n    :flags #{}\n    :mines 40\n    :ticking? false\n    :ticker-handle nil\n    :started false\n    :time 0\n    :game-won? false\n    :game-over? false}))\n\n(rf/reg-event-db\n :set-handle\n (fn [db [_ handle]]\n   (assoc db :ticker-handle handle)))\n\n;; on tick, update the db time (in seconds) if we are currently ticking (not paused).\n(rf/reg-event-db\n :tick\n (fn [{:keys [ticking?] :as db} _]\n   (if ticking?\n     (update db :time inc)\n     db)))\n\n(rf/reg-fx\n :start-ticker-incrementer\n (fn [[handle]]\n   (when (nil? handle)\n     (rf/dispatch [:set-handle (js/setInterval dispatch-timer-event 1000)]))))\n\n(rf/reg-fx\n :stop-ticker\n (fn [[handle]]\n   (when (not (nil? handle))\n     (js/clearInterval handle))))\n\n(rf/reg-event-fx\n :start-timer\n (fn [{:keys [db]} _]\n   {:db (assoc db :ticking? true)    \n    :start-ticker-incrementer [(db :ticker-handle)]}))\n\n(rf/reg-event-fx\n :stop-timer\n (fn [{:keys [db]} _]\n   (prn \"in :stop-timer\")\n   (let [handle (db :ticker-handle)]\n     (prn db)\n     (prn \"stopping timer. \" handle)\n     {:db (assoc db :ticker-handle nil)\n      :stop-ticker [handle]})))\n\n(rf/reg-event-db\n :pause\n (fn [db _]\n   (update db :ticking? not)))\n\n(rf/reg-fx\n :stop-if-game-finished\n (fn [[finished? handle]]\n   (when finished?\n     (prn \"finished. So stop handle\")\n     (js/clearInterval handle))))\n\n(defn reveal-numbers-with-flags\n  [{:keys [board mines] :as db} [x y]]\n  (let [revealed (bf/reveal-with-flags (db :flags) (db :board) [x y])]\n    (if (= :revealed-mine revealed)\n      (assoc db :game-over? true)\n      (let [up-revealed   (set/union revealed (db :revealed))\n            also-revealed (bf/reveal revealed (db :revealed) board)\n            fin-revealed  (set/union up-revealed also-revealed)\n            game-won?     (bf/game-won? fin-revealed board mines)\n            updated-db    (-> db\n                              (assoc :revealed fin-revealed)\n                              (update :flags set/difference fin-revealed)\n                              (assoc :game-won? game-won?))]\n        updated-db))))\n\n(defn reveal-blank\n  [{:keys [board revealed mines] :as db} [x y]]\n  (let [new-revealed (bf/reveal #{[x y]} revealed board)\n        up-revealed (set/union new-revealed revealed)]\n    (-> db\n        (assoc :revealed up-revealed)\n        (assoc :flags (set/difference (db :flags) up-revealed))\n        (assoc :game-won? (bf/game-won? up-revealed board mines)))))\n\n(defn reveal-numbers\n  [{:keys [revealed board mines] :as db} [x y]]\n  (let [up-revealed (set/union revealed #{[x y]})\n        game-won? (bf/game-won? up-revealed board mines)]\n    (-> db\n        (assoc :revealed up-revealed)\n        (assoc :flags (set/difference (db :flags) #{[x y]}))\n        (assoc :game-won? game-won?))))\n\n(rf/reg-event-fx\n :cell-click\n (fn [{:keys [db]} [_ [x y]]]\n   (prn \"cell click\" x y)\n (let [contents (get-in (db :board) [x y])\n       up-db    (cond\n\n                  ;; clicked a mine, game over :(\n                  (= contents :mine)\n                  (assoc db :game-over? true)\n\n                  ;; clicked a blank, reveal all cells until numbers.\n                  (= contents 0)\n                  (reveal-blank db [x y])\n\n                  ;; clicked a number, that isn't a blank cell. Reveal with flags\n                  ;; the cell also has to be revealed\n                  (and (number? contents) ((db :revealed) [x y]))\n                  (reveal-numbers-with-flags db [x y])\n\n                  ;; clicked an unrevealed number, so reveal it.\n                  :else\n                  (reveal-numbers db [x y]))]\n   (prn \"Finished? \" (or (up-db :game-over?) (up-db :game-won?)))\n   {:db                    (assoc up-db :started? true)\n    :stop-if-game-finished [(or (up-db :game-over?) (up-db :game-won?)) (up-db :ticker-handle)]})))\n\n(rf/reg-event-db\n :toggle-flag\n (fn [{:keys [flags] :as db} [_ cell]]\n   (let [up-flags (if (flags cell)\n                    (set/difference flags #{cell})\n                    (conj flags cell))]\n     (assoc db :flags up-flags))))\n\n;; dev test events. To remove.\n\n(rf/reg-event-db\n :set-game-over\n (fn [db _]\n   (assoc db :game-over? (not (db :game-over?)))\n   ))\n\n(rf/reg-event-db\n :reset\n (fn [_ [_ game]]\n   game))\n\n(comment\n\n  \n  )"]}